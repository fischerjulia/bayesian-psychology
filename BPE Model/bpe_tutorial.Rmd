---
title: "Modeling with uncertainty: A Bayesian parameter estimation tutorial"
output:
  pdf_document: default
  html_document:
    toc: true
    toc_depth: 4
    code_download: true
  word_document: default
  rmdformats::robobook:
    highlight: tango
editor_options:
  chunk_output_type: inline
---

# Introduction

## Technical objective
Learn the basics of Bayesian parameter estimation, a Bayesian data analysis technique, and how it differs from frequentist parameter estimation

## Substantive research question
How do emotion regulation strategies moderate the association between sleep and negative emotions?

## Emotion regulation
In this tutorial, we will be applying the Bayesian lens to the estimation of parameters in a multilevel linear model. In **Bayesian parameter estimation**, we view parameter estimates as probability distributions, as opposed to point values. In the following Bayesian data analysis models, we will examine two emotion regulation strategies, cognitive reappraisal and expressive suppression, and whether they moderate the association between hours of sleep at night and negative affect the following day.

Briefly, in *cognitive reappraisal*, one changes the way in which they think about an emotionally-inducing event in order to alter their emotional response to that event. For example, instead of thinking about an exam as a difficult and consequential test of their abilities, a student might choose to frame the exam as an opportunity to show what they have learned. In *expressive suppression*, one regulates their emotions by inhibiting their external displays of emotion. For example, a student who feels nervous about an upcoming exam may stop themselves from showing a worried look on their face and telling their friends that they feel nervous. More information on these two emotion regulation strategies can be found in Gross & John (2003).

## The present study: emotion regulation, sleep, and negative affect

In our analysis, we will be looking at the relationships among these emotion regulation strategies, sleep, and negative affect (emotion). An individual's emotion regulation and coping strategies are thought to moderate the impact of stress on sleep quality (Kahn et al., 2013). We might also be interested in whether emotion regulation strategies moderate the impact of sleep on negative emotions the following day. In other words, does a particular emotion regulation strategy help me manage my negative emotions after a night of poor sleep? 

While we may not be able to precisely pin down the causal structure of the interactions between emotion regulation, sleep, and negative affect, we can run a regression analysis to get some preliminary insights. Our data come from the AMIB study, a multiple time-scale study of college students (Ram et al., 2012). In particular, we will be looking at students' daily self-reports of their sleep and negative affect over the course of eight days, as well as their dispositional reappraisal and suppression scores. The data can be downloaded from https://thechangelab.stanford.edu/collaborations/the-amib-data/.

TODO: add more commentary throughout to guide reader through the steps of the tutorial
TODO: use this link for some example plots/analysis of Bayesian MLMs: https://www.rensvandeschoot.com/tutorials/brms-started/

# Preliminaries

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(brms)
library(psych)
library(tinytex)
library(tidyverse)
```

We begin by loading in the data from the online repository.

```{r person-level data}
# set filepath for data file
filepath <- "https://raw.githubusercontent.com/LRI-2/Data/main/ILD/AMIBshare_persons_2019_0501.csv"
# read in the .csv file using the url() function
AMIB_persons <- read.csv(file=url(filepath),header=TRUE)
```

```{r day-level data}
# set filepath for data file
filepath <- "https://raw.githubusercontent.com/LRI-2/Data/main/ILD/AMIBshare_daily_2019_0501.csv"
# read in the .csv file using the url() function
AMIB_daily <- read.csv(file=url(filepath),header=TRUE)
```

# Data manipulation

We merge the daily-level variables (participant ID, day, hours of sleep, and negative affect) with the person-level variables (participant ID, reappraisal score, suppression score) into a single dataset.

```{r format data}
# subset to day-level variables of interest
bpe_daily <- AMIB_daily[,c("id", "day", "slphrs", "negaff")]
# subset to person-level variables of interest
bpe_persons <- AMIB_persons[,c("id", "erq_reap", "erq_supp")]
# merge day- and person-level data
bpe_data <- merge(bpe_daily, bpe_persons, by = "id")
```

We center the emotion regulation questionnaire scores to facilitate the interpretation of model results.

```{r center predictor}
# center the erq subscale score variables for interpretability
bpe_data$erq_reap_c <- scale(bpe_data$erq_reap, center=TRUE,scale=FALSE)[,1]
bpe_data$erq_supp_c <- scale(bpe_data$erq_supp, center=TRUE,scale=FALSE)[,1]
```

# Initial data plotting

Before running our models, it can be helpful to examine the raw data.

## Correlations and distributions

```{r plot correlations}
# calculate correlations
cor(bpe_data[ ,c(-1, -5, -6)], use = "complete.obs") # dropping the id and non-centered erq columns
# plot correlations
pairs.panels(bpe_data[ ,c(-1, -5, -6)])
```

We see relatively weak correlations overall, but note a weak negative correlation between hours of sleep and level of negative affect (-0.16), as well as a weak negative correlation between cognitive reappraisal and expressive suppression (-0.13). We also observe a weak negative correlation between day in study and level of negative affect (-0.14).

The distributions of the variables can be seen on the diagonal. Of particular interest, we note that the distribution of cognitive reappraisal scores has a negative skew, while the distribution of expressive suppression scores is relatively symmetrical.

## Linear regression: negative affect vs. sleep hours

```{r negaff vs. slphrs, warning=FALSE, message=FALSE}
ggplot(data=bpe_data, aes(x=slphrs, y=negaff)) +
  geom_point() +
  geom_smooth(method=lm, lty=1, size=2) +
  xlab("Hours of Sleep") + ylab("Negative Affect Level") +
  theme_classic() +
  theme(axis.title=element_text(size=16),
        axis.text=element_text(size=12),
        plot.title=element_text(size=16, hjust=.5)) +
  ggtitle("Negative Affect and Sleep")
```

We see that in general, more sleep is associated with lower negative affect. However, there is a wide spread of negative affect values for many sleep durations.

TODO: add a section going over the basics of Bayesian parameter estimation and how it differs from frequentist parameter estimation; make sure to go into enough mathematical detail

# Cognitive reappraisal model

TODO: add model equation in Latex

```{r bpe model reap}
bpe.reap <- brm(negaff ~ 1 + day + slphrs + erq_reap_c + slphrs:erq_reap_c
                  + (1 + slphrs + erq_reap_c|id), data = bpe_data, family = gaussian(),
  iter = 2000, chains = 4, cores = 4)
summary(bpe.reap)
bayes_R2(bpe.reap)
plot(bpe.reap)
```

TODO: interpret model results (including Bayesian significance testing)
TODO: make a visualization of this model that shows the prototypical individual and all individuals

# Expressive suppression model

TODO: add model equation in Latex

```{r bpe model supp}
bpe.supp <- brm(negaff ~ 1 + day + slphrs + erq_supp_c + slphrs:erq_supp_c
                + (1 + slphrs + erq_supp_c|id), data = bpe_data, family = gaussian(),
  iter = 2000, chains = 4, cores = 4)
summary(bpe.supp)
bayes_R2(bpe.supp)
plot(bpe.supp)
```

TODO: interpret model results (including Bayesian significance testing)
TODO: make a visualization of this model that shows the prototypical individual and all individuals

TODO: compare the fits of the two models (reap vs. supp) using **Bayes factor**

TODO: write up a final analysis/conclusion for this tutorial

# Conclusion
[TODO]

# References

Gross, J. J., & John, O. P. (2003). Individual differences in two emotion regulation processes: Implications for affect, relationships, and well-being. *Journal of Personality and Social Psychology*, *85*(2), 348–362. https://doi.org/10.1037/0022-3514.85.2.348

Kahn, M., Sheppes, G., & Sadeh, A. (2013). Sleep and emotions: Bidirectional links and underlying mechanisms. *International Journal of Psychophysiology*, *89*(2), 218–228. https://doi.org/10.1016/j.ijpsycho.2013.05.010

Ram, N., Conroy, D. E., Pincus, A. L., Hyde, A. L., & Molloy, L. E. (2012). Tethering theory to method: Using measures of intraindividual variability to operationalize individuals’ dynamic characteristics. In G. Hancock & J. Harring (Eds.), *Advances in longitudinal methods in the social and behavioral sciences* (pp. 81-110). New York: Information Age.